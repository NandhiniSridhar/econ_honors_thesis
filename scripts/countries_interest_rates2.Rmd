---
title: "countries_interest_rates"
author: "Nandhini Sridhar"
output: html_document
date: "2023-11-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r}
library(tidyverse)
library(readxl)
library(ggplot2)
library(fuzzyjoin) #fuzzy matching of strings
library(lfe) #fixed effects regression
library(fixest) #fixed effects regression
library(expss) #tables
library(gtsummary) #output regression results to table


#packages
#lfe - install.packages("lfe")
#fixest - install.packages("fixest")
#expss - install.packages("expss)
#gtsummary - install.packages("gtsummary")

```

DATA CLEANING
```{r}
setwd("/Users/NandhiniSridhar/Desktop/econ_honors_thesis")
mfdata <- read_excel("/Users/NandhiniSridhar/Desktop/econ_honors_thesis/data/Microfinance/mix-market-financial-performance-dataset-in-usd.xlsx")
#View(mfdata)

country_data <- read_excel("/Users/NandhiniSridhar/Desktop/econ_honors_thesis/data/Microfinance/COUNTRY_CODEBOOKmix-market-mfi-company-metadata.xlsx")
#View(country_data)

names(mfdata) <- gsub(' ', '_', names(mfdata))
names(country_data) <- gsub(' ', '_', names(country_data))

ir <- read_excel("/Users/NandhiniSridhar/Desktop/econ_honors_thesis/data/Microfinance/Interest_Rates.xlsx")
colnames(ir)
cols <- c("Country", "Scale", "Base Year")
for (i in 2000:2021){
  cols <- cols %>% append(i)
}
print(cols)
names(ir) <- cols
ir <- ir[6:nrow(ir),]
```

```{r}
mfdata['Country'] <- NA
countries <- c()
enter <- c()
ifc <- c()
elsec <- c()
names <- c()

#get the countries of each bank in the mfi dataset
for (i in 1:nrow(mfdata)) {
  mfi_name <- mfdata$MFI_Name[i]
  enter <- enter %>% append(1)
  
  if(mfi_name %in% country_data$MFI_Name){
    ifc <- ifc %>% append(1)
    country_name <- country_data$Country[country_data$MFI_Name == mfi_name]
    names <- names %>% append(length(country_name))
    countries <- countries %>% append(country_name)
    #mfdata[i, 'country'] <- country_name
  }
  else{
    elsec <- elsec %>% append(1)
    countries <- countries %>% append("NOT FOUND")
  }
}

# get rid of ones with multiple countries (would have repeats of the same country for some reason)
names2 <- c()
for(i in 1:length(names)){
  if(names[i] == 2){
    names2 <- names2 %>% append(1)
    cat(names[i], ": ", countries[i], "\n")
    countries <- countries[-i]
  }
}

#append to mfi dataset
mfdata$Country <- countries
```
```{r}
print(nrow(mfdata))
mfdata <- mfdata %>% drop_na("Gross_Loan_Portfolio")
mfdata <- mfdata %>% drop_na("Percent_of_female_borrowers")
mfdata <- mfdata %>% drop_na(`Gross_Loan_Portfolio_>_Gender_>_Female`)
print(nrow(mfdata))

mfdata$Ratio_GLP_Female = mfdata$`Gross_Loan_Portfolio_>_Gender_>_Female` / mfdata$Gross_Loan_Portfolio
print(nrow(mfdata))
mfdata <- mfdata %>% filter(Ratio_GLP_Female <= 1)
```

```{r}
#arrange by MFI name and fiscal year
mfdata <- mfdata %>% filter(Period_Type == "ANN") %>% arrange(MFI_Name, Fiscal_Year)
#mfdata['country_reduced'] <- gsub(",.*", "", mfdata$country)
#mfdata['country_reduced'] <- gsub("\\(.*", "", mfdata$country)
#names(country_data) <- gsub(' ', '_', names(country_data))

mf_interest <- stringdist_join(mfdata, ir, 
                by='Country', 
                mode='left',
                method = "soundex") %>%
  arrange(Country.x)


#Ratio_GLP_Female is the y variable - the percentage of loan money that goes to women borrowers
mf_interest %>% drop_na(`Gross_Loan_Portfolio`)
mf_interest %>% drop_na(`Gross_Loan_Portfolio_>_Gender_>_Female`)

mf_interest$Ratio_GLP_Female = mf_interest$`Gross_Loan_Portfolio_>_Gender_>_Female` / mf_interest$Gross_Loan_Portfolio
```

```{r}
#encode by region
#World Bank region classifications: Africa, East Asia & the Pacific, Europe & Central Asia, Latin America & The Caribbean, Middle East & North Africa, South Asia
africa <- c("Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", "Cameroon", "Cabo Verde", "Central African Republic", "Chad", "Comoros", "Cote d'Ivore", "Cote d'Ivoire (Ivory Coast)", "Congo", "Congo, Democratic Republic of the","Congo, Republic of the", "Equitorial Guinea", "Eritrea", "Eswatini", "Ethiopia", "Gabon", "Ghana", "Gambia", "Gambia, The", "Guinea", "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritus", "Mozambique", "Nambia", "Niger", "Nigeria", "Rwanda", "Senegal", "Sierra Leone", "Somalia", "South Africa", "South Sudan", "Sudan", "Tanzania", "Togo", "Uganda", "Zambia", "Zimbabwe", "Namibia", "Swaziland")

east_asia_pacific <- c("Cambodia", "China", "China, People's Republic of", "Indonesia", "Korea", "Lao PDR", "Malaysia", "Mongolia", "Myanmar", "Papua New Guinea", "Philippines", "Singapore", "Thailand", "Vietnam", "East Timor", "Laos", "Myanmar (Burma)", "Samoa", "Solomon Islands", "Tonga", "Vanuatu")

europe_central_asia <- c("Albania", "Armenia", "Azerbaijan", "Belarus", "Bosnia and Herzegovina", "Bulgaria", "Croatia", "Georgia", "Hungary", "Kazakhstan", "Kosovo", "Kyrgyzstan", "Moldova", "Montenegro", "Macedonia", "Poland", "Romania", "Russia", "Serbia", "Tajikistan", "Turkey", "Turkmenistan", "Ukraine", "Uzbekistan", "Slovakia")

latin_america_caribbean <- c("Argentina", "Belize", "Bolivia", "Brazil", "Colombia", "Chile", "Costa Rica", "Dominican Republic", "Ecuador", "El Salvador", "Grenada", "Guatemala", "Guyana", "Haiti", "Honduras", "Jamaica", "Mexico", "Nicaragua", "Panama", "Paraguay", "Peru", "Saint Lucia", "Suriname", "Trinidad and Tobago", "Uruguay", "Venezuela", "Fiji")

middle_east_north_africa <- c("Algeria", "Bahrain", "Djibouti", "Egypt", "Iran", "Iraq", "Jordan", "Kuwait", "Lebanon", "Libya", "Morocco", "Oman", "Palestine", "Qatar", "Saudi Arabia", "Syria", "Tunisia", "United Arab Emirates", "Yemen", "Israel")

south_asia <- c("Sri Lanka", "Bangladesh", "India", "Afghanistan", "Pakistan", "Bhutan", "Nepal", "Maldives")

north_america <- c("United States", "Canada")

mfdata <- mfdata %>% 
  mutate(Region = case_when(
    Country %in% africa ~ 'Sub_Saharan_Africa',
    Country %in% east_asia_pacific ~ 'East_Asia_Pacific',
    Country %in% europe_central_asia ~ 'Europe_Central_Asia',
    Country %in% middle_east_north_africa ~ 'Middle_East_North_Africa',
    Country %in% north_america ~ 'North_America',
    Country %in% latin_america_caribbean ~ 'Latin_America_Caribbean',
    Country %in% south_asia ~ 'South_Asia',
    TRUE ~ 'Other'))

mf_interest <- mf_interest %>% 
  mutate(Region = case_when(
    Country.x %in% africa ~ 'Sub_Saharan_Africa',
    Country.x %in% east_asia_pacific ~ 'East_Asia_Pacific',
    Country.x %in% europe_central_asia ~ 'Europe_Central_Asia',
    Country.x %in% middle_east_north_africa ~ 'Middle_East_North_Africa',
    Country.x %in% north_america ~ 'North_America',
    Country.x %in% latin_america_caribbean ~ 'Latin_America_Caribbean',
    Country.x %in% south_asia ~ 'South_Asia',
    TRUE ~ 'Other'))

x <- mf_interest %>% filter(Region == "Other")
print(unique(x$Country.x))
```

```{r}
# instrumental variable is the interest rate for a given year
# here i create the variable that can be used as a common instrument (interest rates are originally split one year per column)
# here i only take the interest rate that directly corresponds to the fiscal year for a given entry

mf_interest$Cur_Interest_Rate = 9999 #this is the error code


for(i in 1:nrow(mf_interest)){
  year = mf_interest$Fiscal_Year[i]
  if(mf_interest$Fiscal_Year[i] != 1999){
    if(mf_interest[i, as.character(year)] != "..." & !is.na(mf_interest[i, as.character(year)]) & mf_interest[i, as.character(year)] != "-"){
      #print(i)
      #print(mf_interest[i, as.character(year)])
      mf_interest$Cur_Interest_Rate[i] <- mf_interest[i, as.character(year)]
    }
  }
  #if(suppressWarnings(is.na(as.numeric(mf_interest$Cur_Interest_Rate))[i])){
  #  print(mf_interest$Cur_Interest_Rate[i])
  #}
}
#unique(mf_interest$Cur_Interest_Rate)

mf_interest$Cur_Interest_Rate <- as.numeric(mf_interest$Cur_Interest_Rate)
```

```{r}
mf_interest <- mf_interest %>% drop_na("Gross_Loan_Portfolio")
mf_interest <- mf_interest %>% drop_na("Ratio_GLP_Female")
mf_interest <- mf_interest %>% drop_na("Percent_of_female_borrowers")


working_mf_interest <- mf_interest %>% filter(Cur_Interest_Rate != 9999)
working_mf_interest <- working_mf_interest %>% drop_na("Cur_Interest_Rate")
working_mf_interest <- working_mf_interest %>% filter(Region == "South_Asia" | Region == "Latin_America_Caribbean" | Region == "Sub_Saharan_Africa")
```

```{r}
#use for GLP, %women borrowers, %GLP to women over time for all data
mfdata_no_null <- mfdata %>% drop_na(Gross_Loan_Portfolio)
mfdata_no_null <- mfdata_no_null %>% drop_na(Percent_of_female_borrowers)
mfdata_no_null <- mfdata_no_null %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
mfdata_no_null <- mfdata_no_null %>% drop_na(Ratio_GLP_Female)

year_totals_all <- data.frame(matrix(ncol=6, nrow=0))
colnames(year_totals_all) <- c("Fiscal_Year", "Average_Gross_Loan_Portfolio", "Average_Percent_Female_Borrowers", "Average_Fraction_GLP_To_Women", "Average_Number_Female_Borrowers", "Num_MFIs")
min_year_all <- min(mfdata_no_null$Fiscal_Year)
max_year_all <- max(mfdata_no_null$Fiscal_Year)

year_totals <- data.frame(matrix(ncol=6, nrow=0))
colnames(year_totals) <- c("Fiscal_Year", "Average_Gross_Loan_Portfolio", "Average_Percent_Female_Borrowers", "Average_Fraction_GLP_To_Women", "Average_Number_Female_Borrowers", "Num_MFIs")
min_year <- min(working_mf_interest$Fiscal_Year)
max_year <- max(working_mf_interest$Fiscal_Year)


#stats by year for all data
row <- 1
for(i in min_year_all:max_year_all){
  year_totals_all[row, "Fiscal_Year"] <- i
  temp <- mfdata %>% filter(Fiscal_Year == i)
  temp <- temp %>% drop_na(Gross_Loan_Portfolio)
  temp <- temp %>% drop_na(Percent_of_female_borrowers)
  temp <- temp %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
  temp <- temp %>% drop_na(Ratio_GLP_Female)

  num_mfi <- nrow(temp)
  cat(c("temp: ", num_mfi, "\n"))
  year_totals_all[row, "Average_Gross_Loan_Portfolio"] <- mean(temp$Gross_Loan_Portfolio)
  year_totals_all[row, "Average_Percent_Female_Borrowers"] <- mean(temp$Percent_of_female_borrowers)
  year_totals_all[row, "Average_Fraction_GLP_To_Women"] <- mean(temp$Ratio_GLP_Female)
  year_totals_all[row, "Average_Number_Female_Borrowers"] <- mean(temp$`Number_of_active_borrowers_>_Gender_>_Female`)
  year_totals_all[row, "Num_MFIs"] <- num_mfi
  row = row + 1
}

#stats by year for working data
row <- 1
for(i in min_year:max_year){
  year_totals[row, "Fiscal_Year"] <- i
  temp <- working_mf_interest %>% filter(Fiscal_Year == i)
  
  num_mfi <- nrow(temp)
  cat(c("temp: ", num_mfi, "\n"))
  
  year_totals[row, "Average_Gross_Loan_Portfolio"] <- mean(temp$Gross_Loan_Portfolio)
  year_totals[row, "Average_Percent_Female_Borrowers"] <- mean(temp$Percent_of_female_borrowers)
  year_totals[row, "Average_Fraction_GLP_To_Women"] <- mean(temp$Ratio_GLP_Female)
  year_totals[row, "Average_Number_Female_Borrowers"] <- mean(temp$`Number_of_active_borrowers_>_Gender_>_Female`)
  year_totals[row, "Num_MFIs"] <- num_mfi

  row = row + 1
}


print(year_totals_all %>% setDT())
print(year_totals %>% setDT())
```
```{r}
#use for GLP, %women borrowers, %GLP to women over time for all data
mfdata_ssa <- mfdata %>% drop_na(Gross_Loan_Portfolio) %>% filter(Region == "Sub_Saharan_Africa")
mfdata_ssa <- mfdata_ssa %>% drop_na(Percent_of_female_borrowers)
mfdata_ssa <- mfdata_ssa %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
mfdata_ssa <- mfdata_ssa %>% drop_na(Ratio_GLP_Female)

year_totals_ssa <- data.frame(matrix(ncol=6, nrow=0))
colnames(year_totals_ssa) <- c("Fiscal_Year", "Average_Gross_Loan_Portfolio", "Average_Percent_Female_Borrowers", "Average_Fraction_GLP_To_Women", "Average_Number_Female_Borrowers", "Num_MFIs")
min_year_ssa <- min(mfdata_ssa$Fiscal_Year)
max_year_ssa <- max(mfdata_ssa$Fiscal_Year)

ssa_totals <- data.frame(matrix(ncol=6, nrow=0))
colnames(ssa_totals) <- c("Fiscal_Year", "Average_Gross_Loan_Portfolio", "Average_Percent_Female_Borrowers", "Average_Fraction_GLP_To_Women", "Average_Number_Female_Borrowers", "Num_MFIs")
min_year <- min(mfdata_ssa$Fiscal_Year)
max_year <- max(mfdata_ssa$Fiscal_Year)


#stats by year for all data
row <- 1
for(i in min_year_ssa:max_year_ssa){
  year_totals_ssa[row, "Fiscal_Year"] <- i
  temp <- mfdata_ssa %>% filter(Fiscal_Year == i)
  temp <- temp %>% drop_na(Gross_Loan_Portfolio)
  temp <- temp %>% drop_na(Percent_of_female_borrowers)
  temp <- temp %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
  temp <- temp %>% drop_na(Ratio_GLP_Female)

  num_mfi <- nrow(temp)
  cat(c("temp: ", num_mfi, "\n"))
  year_totals_ssa[row, "Average_Gross_Loan_Portfolio"] <- mean(temp$Gross_Loan_Portfolio)
  year_totals_ssa[row, "Average_Percent_Female_Borrowers"] <- mean(temp$Percent_of_female_borrowers)
  year_totals_ssa[row, "Average_Fraction_GLP_To_Women"] <- mean(temp$Ratio_GLP_Female)
  year_totals_ssa[row, "Average_Number_Female_Borrowers"] <- mean(temp$`Number_of_active_borrowers_>_Gender_>_Female`)
  year_totals_ssa[row, "Num_MFIs"] <- num_mfi
  row = row + 1
}
```
```{r}
#use for GLP, %women borrowers, %GLP to women over time for all data
mfdata_lac <- mfdata %>% drop_na(Gross_Loan_Portfolio) %>% filter(Region == "Latin_America_Caribbean")
mfdata_lac <- mfdata_lac %>% drop_na(Percent_of_female_borrowers)
mfdata_lac <- mfdata_lac %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
mfdata_lac <- mfdata_lac %>% drop_na(Ratio_GLP_Female)

year_totals_lac <- data.frame(matrix(ncol=6, nrow=0))
colnames(year_totals_lac) <- c("Fiscal_Year", "Average_Gross_Loan_Portfolio", "Average_Percent_Female_Borrowers", "Average_Fraction_GLP_To_Women", "Average_Number_Female_Borrowers", "Num_MFIs")
min_year_lac <- min(mfdata_lac$Fiscal_Year)
max_year_lac <- max(mfdata_lac$Fiscal_Year)

#stats by year for all data
row <- 1
for(i in min_year_lac:max_year_lac){
  year_totals_lac[row, "Fiscal_Year"] <- i
  temp <- mfdata_lac %>% filter(Fiscal_Year == i)
  temp <- temp %>% drop_na(Gross_Loan_Portfolio)
  temp <- temp %>% drop_na(Percent_of_female_borrowers)
  temp <- temp %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
  temp <- temp %>% drop_na(Ratio_GLP_Female)

  num_mfi <- nrow(temp)
  cat(c("temp: ", num_mfi, "\n"))
  year_totals_lac[row, "Average_Gross_Loan_Portfolio"] <- mean(temp$Gross_Loan_Portfolio)
  year_totals_lac[row, "Average_Percent_Female_Borrowers"] <- mean(temp$Percent_of_female_borrowers)
  year_totals_lac[row, "Average_Fraction_GLP_To_Women"] <- mean(temp$Ratio_GLP_Female)
  year_totals_lac[row, "Average_Number_Female_Borrowers"] <- mean(temp$`Number_of_active_borrowers_>_Gender_>_Female`)
  year_totals_lac[row, "Num_MFIs"] <- num_mfi
  row = row + 1
}
```
```{r}
#use for GLP, %women borrowers, %GLP to women over time for all data
mfdata_sasia <- mfdata %>% drop_na(Gross_Loan_Portfolio) %>% filter(Region == "South_Asia")
mfdata_sasia <- mfdata_sasia %>% drop_na(Percent_of_female_borrowers)
mfdata_sasia <- mfdata_sasia %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
mfdata_sasia <- mfdata_sasia %>% drop_na(Ratio_GLP_Female)

year_totals_sasia <- data.frame(matrix(ncol=6, nrow=0))
colnames(year_totals_sasia) <- c("Fiscal_Year", "Average_Gross_Loan_Portfolio", "Average_Percent_Female_Borrowers", "Average_Fraction_GLP_To_Women", "Average_Number_Female_Borrowers", "Num_MFIs")
min_year_sasia <- min(mfdata_sasia$Fiscal_Year)
max_year_sasia <- max(mfdata_sasia$Fiscal_Year)

#stats by year for all data
row <- 1
for(i in min_year_sasia:max_year_sasia){
  year_totals_sasia[row, "Fiscal_Year"] <- i
  temp <- mfdata_sasia %>% filter(Fiscal_Year == i)
  temp <- temp %>% drop_na(Gross_Loan_Portfolio)
  temp <- temp %>% drop_na(Percent_of_female_borrowers)
  temp <- temp %>% drop_na(`Number_of_active_borrowers_>_Gender_>_Female`)
  temp <- temp %>% drop_na(Ratio_GLP_Female)

  num_mfi <- nrow(temp)
  cat(c("temp: ", num_mfi, "\n"))
  year_totals_sasia[row, "Average_Gross_Loan_Portfolio"] <- mean(temp$Gross_Loan_Portfolio)
  year_totals_sasia[row, "Average_Percent_Female_Borrowers"] <- mean(temp$Percent_of_female_borrowers)
  year_totals_sasia[row, "Average_Fraction_GLP_To_Women"] <- mean(temp$Ratio_GLP_Female)
  year_totals_sasia[row, "Average_Number_Female_Borrowers"] <- mean(temp$`Number_of_active_borrowers_>_Gender_>_Female`)
  year_totals_sasia[row, "Num_MFIs"] <- num_mfi
  row = row + 1
}
```


```{r}
#run everything above this to clean and preprocess data
```

TABLES, GRAPHS, AND FIGURES

Tables

```{r}
#number of observations in each table I use
num_obs <- data.frame("Dataframe" = c("Full Dataset", "Full Dataset Without Nulls", "Working Dataset"), Rows=c(nrow(mfdata), nrow(mfdata_no_null), nrow(working_mf_interest)))
num_obs$"Number of Countries" <- c(length(unique(mfdata$Country)), length(unique(mfdata_no_null$Country)), length(unique(working_mf_interest$Country.x)))
num_obs$"Number of MFIs" <- c(length(unique(mfdata$MFI_ID)), length(unique(mfdata_no_null$MFI_ID)), length(unique(working_mf_interest$MFI_ID)))

num_obs_table <- setDT(num_obs)
print(num_obs_table)
```

```{r}
#stats for entire dataset
mfdata_no_null <- mfdata_no_null %>% apply_labels(
  Gross_Loan_Portfolio = "Gross Loan Portfolio",
  Percent_of_female_borrowers = "Percent of Female Borrowers",
  Ratio_GLP_Female = "Fraction of GLP to Female Borrowers",
  `Number_of_active_borrowers_>_Gender_>_Female` = "Number of Female Borrowers",
  Region = "Percent of Data From Regions",
  Cur_Interest_Rate = "Current Interest Rate"
)

mf_table <- mfdata_no_null %>% 
  tab_total_label("All MIX Market Data") %>%
  tab_cells(Gross_Loan_Portfolio) %>%
  tab_stat_mean() %>%
  tab_cells(Percent_of_female_borrowers) %>%
  tab_stat_mean() %>%
  tab_cells(Ratio_GLP_Female) %>%
  tab_stat_mean() %>%
  #percent of data from each region
  tab_cells(Region) %>%
  tab_stat_cpct() %>%
  tab_pivot()

#mf_table


```


```{r}

working_mf_interest <- working_mf_interest %>% apply_labels(
  Gross_Loan_Portfolio = "Gross Loan Portfolio",
  Percent_of_female_borrowers = "Percent of Female Borrowers",
  Ratio_GLP_Female = "Fraction of GLP to Female Borrowers",
  `Number_of_active_borrowers_>_Gender_>_Female` = "Number of Female Borrowers",
  Region = "Percent of Data From Regions",
  Cur_Interest_Rate = "Current Interest Rate"
)

working_mf_table <- working_mf_interest %>% 
  tab_total_label("Working MIX Market Data") %>%
  tab_cells(Gross_Loan_Portfolio) %>%
  tab_stat_mean() %>%
  tab_cells(Percent_of_female_borrowers) %>%
  tab_stat_mean() %>%
  tab_cells(Ratio_GLP_Female) %>%
  tab_stat_mean() %>%
  #percent of data from each region
  tab_cells(Region) %>%
  tab_stat_cpct() %>%
  tab_pivot()


#i think this achieves the two column effect with the same summary stats for the diff datasets
combined_table <- mf_table %>% merge(working_mf_table)
#working_mf_table
#mf_table
combined_table
```
```{r}
region_summary_full <-mfdata %>% select(Region)
region_summary <- working_mf_interest %>% select(Region)

full_region_tbl <- tbl_summary(region_summary_full)
working_region_tbl <- tbl_summary(region_summary)

region <- tbl_merge(
  tbls = list(full_region_tbl, working_region_tbl),
  tab_spanner = c("Full Dataset", "Working Dataset")
)

print(region)
```


```{r}
print(range(mfdata$Fiscal_Year))
print(range(working_mf_interest$Fiscal_Year))

print(summary(mfdata$Gross_Loan_Portfolio))
print(summary(working_mf_interest$Gross_Loan_Portfolio))
# 
# print(summary(mfdata$Ratio_GLP_Female))
# print(summary(working_mf_interest$Ratio_GLP_Female))
# 
# print(summary(mfdata$Percent_of_female_borrowers))
# print(summary(working_mf_interest$Percent_of_female_borrowers))
```


Graphs
```{r}
#mfdata - all MIX Market data
print(length(unique(mfdata$MFI_Name)))
print(length(unique(mfdata$Country)))

ggplot(mfdata, aes(x=Country)) + 
  geom_bar() +
  theme(axis.text.x = element_text(size=5, angle = 90, vjust = 1, hjust=1)) + 
  labs(title="Number of MFIs Reporting Across All Years, By Country", x="Country", y="Number of MFIs")

ggplot(year_totals_all, aes(x=Fiscal_Year, y=Average_Gross_Loan_Portfolio)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_all, max_year_all, by=1)) +
  scale_y_continuous(trans='log10') + 
  labs(title = "Average Gross Loan Portfolios Over Time Across all MFIs - All Data", x="Fiscal Year", y="Gross Loan Portfolio - Log Scaled")
  
ggplot(year_totals_all, aes(x=Fiscal_Year, y=Average_Fraction_GLP_To_Women)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_all, max_year_all, by=1)) +
  scale_y_continuous(breaks = seq(0.0, 1.1, by=0.1)) +
  labs(title = "Average Fraction of GLP to Women Over Time Across MFIs - All Data", x="Fiscal Year", y="Fraction of GLP to Female Borrowers")

ggplot(year_totals_all, aes(x=Fiscal_Year, y=Average_Percent_Female_Borrowers)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_all, max_year_all, by=1)) +
  scale_y_continuous(breaks = seq(0.0, 1.1, by=0.1)) +
  labs(title = "Average Percent of Women Over Time Across MFIs - All Data", x="Fiscal Year", y="Fraction of GLP to Female Borrowers")
    
```

```{r}
#working data - mfis with interest data for relevant years
print(length(unique(working_mf_interest$MFI_Name)))
print(length(unique(working_mf_interest$Country.x)))

ggplot(working_mf_interest, aes(x=Country.x)) + 
  geom_bar() +
  theme(axis.text.x = element_text(size=5, angle = 90, vjust = 1, hjust=1)) + 
  labs(title="MFIs") +
  labs(title="Number of MFIs Reporting Across All Years, By Country", x="Country", y="Number of MFIs")

ggplot(year_totals, aes(x=Fiscal_Year, y=Average_Gross_Loan_Portfolio)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year, max_year, by=1)) +
  labs(title = "Gross Loan Portfolios Over Time Across all MFIs - Working Data", x="Fiscal Year", y="Average Gross Loan Portfolio")
  
ggplot(year_totals, aes(x=Fiscal_Year, y=Average_Fraction_GLP_To_Women)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_all, max_year_all, by=1)) +
  scale_y_continuous(breaks = seq(0, 1, by=0.1)) + 
  labs(title = "Average Fraction of GLP to Women Over Time Across MFIs - Working Data", x="Fiscal Year", y="Average Fraction of GLP to Female Borrowers")
  
ggplot(year_totals, aes(x=Fiscal_Year, y=Average_Percent_Female_Borrowers)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_all, max_year_all, by=1)) +
  scale_y_continuous(breaks = seq(0, 1, by=0.1)) + 
  labs(title = "Average Percentage of Female Borrowers Over Time Across MFIs - Working Data", x="Fiscal Year", y="Average Fraction of GLP to Female Borrowers")
  
```

combine the bar graphs
```{r}
ggplot(data=NULL) +
  geom_bar(data=mfdata, aes(x=Country), color="black", alpha=0) +
  theme(axis.text.x = element_text(size=5, angle = 90, vjust = 1, hjust=1)) + 
  labs(x="Country", y="Number of MFIs Across Years", title="Number of MFIs Reporting Across Countries, Across All Years") +
  geom_bar(data=working_mf_interest, aes(x=Country.x), fill="black") +
  theme(axis.text.x = element_text(size=5, angle = 90, vjust = 1, hjust=1))
  

```
#Graph of number of mfis per year
```{r}
min_all <- min(year_totals_all$Fiscal_Year)
max_all <- max(year_totals_all$Fiscal_Year)
min_work <- min(year_totals$Fiscal_Year)
max_work <- max(year_totals$Fiscal_Year)

ggplot(data=NULL) +
  geom_line(data=year_totals_all, aes(x=Fiscal_Year, y=Num_MFIs), linetype=1) +
  labs(x="Fiscal Year", y="Number of MFIs reporting", title="Number of MFIs reporting per year") +
  scale_x_continuous(breaks = seq(min_all, max_all, by=1)) +
  geom_line(data=year_totals, aes(x=Fiscal_Year, y=Num_MFIs), linetype=2) +
  labs(x="Fiscal Year", y="Number of MFIs reporting", title="Number of MFIs reporting per year") + 
  scale_x_continuous(breaks = seq(min_work, max_work, by=1)) +
  theme(axis.text.x = element_text(size=5, angle = 90, vjust = 1, hjust=1))

  
```

```{r}

```

```{r}
ggplot(year_totals_ssa, aes(x=Fiscal_Year, y=Average_Gross_Loan_Portfolio)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_ssa, max_year_ssa, by=1)) +
  scale_y_continuous(trans='log10') + 
  labs(title = "Average Gross Loan Portfolios Over Time Across all MFIs - Sub Saharan Africa", x="Fiscal Year", y="Gross Loan Portfolio - Log Scaled")

ggplot(year_totals_lac, aes(x=Fiscal_Year, y=Average_Gross_Loan_Portfolio)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_lac, max_year_lac, by=1)) +
  scale_y_continuous(trans='log10') + 
  labs(title = "Average Gross Loan Portfolios Over Time Across all MFIs - Latin America & Caribbean", x="Fiscal Year", y="Gross Loan Portfolio - Log Scaled")

ggplot(year_totals_sasia, aes(x=Fiscal_Year, y=Average_Gross_Loan_Portfolio)) +
  geom_line() +
  scale_x_continuous(breaks = seq(min_year_sasia, max_year_sasia, by=1)) +
  scale_y_continuous(trans='log10') + 
  labs(title = "Average Gross Loan Portfolios Over Time Across all MFIs - South Asia", x="Fiscal Year", y="Gross Loan Portfolio - Log Scaled")
```


```{r}
india <- working_mf_interest %>% filter(Country.x == "India")
ggplot(india, aes(x=Gross_Loan_Portfolio)) + 
  geom_histogram() + 
  labs(title="Density plot of GLP size for Indian MFIs", x="GLP size", y="Frequency")

no_india <- working_mf_interest %>% filter(Country.x != "India")

ggplot(no_india, aes(x=Gross_Loan_Portfolio)) + 
  geom_histogram() +
  labs(title="Density plot of GLP size for non-Indian MFIs", x="GLP size", y="Frequency")
  
ggplot(data=NULL) +
  geom_histogram(data=india, aes(x=Gross_Loan_Portfolio), alpha=1, fill='black') + 
  labs(title="Density plot of GLP size - Indian MFIs Filled", x="GLP size", y="Frequency") +
  geom_histogram(data=no_india, aes(x=Gross_Loan_Portfolio), alpha=0, color='black')

```
^^ This actually shows that India has a similar spread of GLPs amongst its MFIs compared to the rest of the world

Ranges for GLP for every country:
```{r}
for(i in unique(working_mf_interest$Country.x)){
  temp <- working_mf_interest %>% filter(Country.x == i)
  print(i)
  print(summary(temp$Gross_Loan_Portfolio))
  #cat(i, ": ", summary(temp$Gross_Loan_Portfolio), "\n", sep="")
}
```


```{r}
summary(working_mf_interest$Percent_of_female_borrowers)
sd(working_mf_interest$Percent_of_female_borrowers)
summary(working_mf_interest$Gross_Loan_Portfolio)
sd(working_mf_interest$Gross_Loan_Portfolio)
sd(log(working_mf_interest$Gross_Loan_Portfolio))

unique_full <- unique(mfdata$Country)
unique_working <- unique(working_mf_interest$Country.x)

cat("Full dataset: ", length(unique_full), "\n")
cat("Working dataset: ", length(unique_working))

```

``REGRESSIONS FROM HERE AND BELOW``


REGRESSIONS ON PERCENT OF FEMALE BORROWERS:

Basic OLS
```{r}
#basic model, no fixed effects
basic_linear <- lm(Percent_of_female_borrowers ~ Gross_Loan_Portfolio, data=working_mf_interest)
print(summary(basic_linear))

basic_log <- lm(Percent_of_female_borrowers ~ log(Gross_Loan_Portfolio), data=working_mf_interest)
print(summary(basic_log))
```

Only Fixed Effects, no instrument
```{r}
#percent is from 0 to 1

time_mfi_fe_pct <- felm(Percent_of_female_borrowers ~ log(Gross_Loan_Portfolio) | MFI_Name + Fiscal_Year | 0 | MFI_Name, working_mf_interest)
print(summary(time_mfi_fe_pct))

time_country_fe_pct <- felm(Percent_of_female_borrowers ~ log(Gross_Loan_Portfolio) | Country.x + Fiscal_Year | 0 | MFI_Name, working_mf_interest)
print(summary(time_country_fe_pct))

#include region fixed effects
time_region_fe_pct <- felm(Percent_of_female_borrowers ~ log(Gross_Loan_Portfolio) | Region + Fiscal_Year | 0 | MFI_Name, working_mf_interest)
print(summary(time_region_fe_pct))

```

Includes both time and cross sectional fixed effects and interest rate as an instrumental variable

Cross sectional fixed effect by MFI
```{r}
fe_inst_1_mfi <- feols(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate | MFI_Name + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest, )
print(summary(fe_inst_1_mfi))


working_mf_interest$predicted_log_GLP <- predict(fe_inst_1_mfi, new_data=working_mf_interest$predicted_log_GLP)

fe_inst_2_mfi <- feols(Percent_of_female_borrowers ~ predicted_log_GLP | MFI_Name + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest)
print(summary(fe_inst_2_mfi))
```

Cross sectional fixed effect by region
```{r}
#first stage here is weak so second stage isn't working, fixed effects are doing everything
fe_inst_1_reg <- feols(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate | Region + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest, )
print(summary(fe_inst_1_reg))

working_mf_interest$predicted_log_GLP <- predict(fe_inst_1_reg, new_data=working_mf_interest$predicted_log_GLP)

fe_inst_2_reg <- feols(Percent_of_female_borrowers ~ predicted_log_GLP | Region + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest)
print(summary(fe_inst_2_reg))
```
Cross sectional fixed effect by country
```{r}
fe_inst_1_country <- feols(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate | Country.x + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest, )
print(summary(fe_inst_1_country))

#fe_inst_1_rat_country <- feols(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate | Country.x + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest, )


working_mf_interest$predicted_log_GLP <- predict(fe_inst_1_country, new_data=working_mf_interest$predicted_log_GLP)

fe_inst_2_country <- feols(Percent_of_female_borrowers ~ predicted_log_GLP | Country.x + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest)
print(summary(fe_inst_2_country))
```




REGRESSIONS ON RATIO OF GLP TO WOMEN

Basic OLS
```{r}
#basic model, no fixed effects
basic_linear <- lm(Ratio_GLP_Female ~ Gross_Loan_Portfolio, data=working_mf_interest)
print(summary(basic_linear))

basic_log <- lm(Ratio_GLP_Female ~ log(Gross_Loan_Portfolio), data=working_mf_interest)
print(summary(basic_log))
```

Only Fixed Effects, no instrument
```{r}
#With time and mfi fixed effects
#the 0 means no instrumental variables
#what standard error clustering dim do i use (right now doing it by mfi)
time_mfi_fe_rat <- felm(Ratio_GLP_Female ~ log(Gross_Loan_Portfolio) | MFI_Name + Fiscal_Year | 0 | MFI_Name, working_mf_interest)
print(summary(time_mfi_fe_rat))

time_country_fe_rat <- felm(Ratio_GLP_Female ~ log(Gross_Loan_Portfolio) | Country.x + Fiscal_Year | 0 | MFI_Name, working_mf_interest)
print(summary(time_country_fe_rat))

#include region fixed effects
time_region_fe_rat <- felm(Ratio_GLP_Female ~ log(Gross_Loan_Portfolio) | Region + Fiscal_Year | 0 | MFI_Name, working_mf_interest)
print(summary(time_region_fe_rat))
```


Fixed effects and instrument
Cross Sectional Fixed Effect by MFI
```{r}

fe_inst_1_rat_mfi <- feols(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate | MFI_Name + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest)
print(summary(fe_inst_1_rat_mfi))

working_mf_interest$predicted_log_GLP <- predict(fe_inst_1_rat_mfi, new_data=working_mf_interest$predicted_log_GLP)

fe_inst_2_rat_mfi <- feols(Ratio_GLP_Female ~ predicted_log_GLP | MFI_Name + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest)
print(summary(fe_inst_2_rat_mfi))
```
Cross Sectional Fixed Effect by Country
```{r}
fe_inst_1_rat_country <- feols(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate | Country.x + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest, )
print(summary(fe_inst_1_rat_country))

working_mf_interest$predicted_log_GLP <- predict(fe_inst_1_rat_country, new_data=working_mf_interest$predicted_log_GLP)

fe_inst_2_rat_country <- feols(Ratio_GLP_Female ~ predicted_log_GLP | Country.x + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest)
print(summary(fe_inst_2_rat_country))
```

Cross Sectional Fixed Effect by Region
This seems to be the only one that's nearly statistically significant- the others have very high p vals
```{r}
fe_inst_1_rat_reg <- feols(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate | Region + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest, )
print(summary(fe_inst_1_rat_reg))

working_mf_interest$predicted_log_GLP <- predict(fe_inst_1_rat_reg, new_data=working_mf_interest$predicted_log_GLP)

fe_inst_2_rat_reg <- feols(Ratio_GLP_Female ~ predicted_log_GLP | Region + Fiscal_Year, cluster="MFI_Name", data=working_mf_interest)
print(summary(fe_inst_2_rat_reg))
```

```{r}
#Pecent of female borrowers
mfi_fe_pct <- tbl_regression(time_mfi_fe_pct)
country_fe_pct <- tbl_regression(time_country_fe_pct)
region_fe_pct <- tbl_regression(time_region_fe_pct)

mfi_feiv_pct <- tbl_regression(fe_inst_2_mfi)
country_feiv_pct <- tbl_regression(fe_inst_2_country)
region_feiv_pct <- tbl_regression(fe_inst_2_reg)

theme_gtsummary_journal(journal = "qjecon")

# pct_female_FE <- tbl_merge(
#   tbls = list(mfi_fe_pct, country_fe_pct, region_fe_pct),
#   tab_spanner = c("**MFI Fixed Effects**", "**Country Fixed Effects**", "**Region Fixed Effects**")
# )

# pct_female_FE_IV <- tbl_merge(
#   tbls=list(mfi_feiv_pct, country_feiv_pct, region_feiv_pct),
#   tab_spanner = c("**MFI Fixed Effects**", "**Country Fixed Effects**", "**Region Fixed Effects**")
# )
# 
# pct_female_FEvsIV <- tbl_merge(
#   tbls=list(pct_female_FE, pct_female_FE_IV),
#   tab_spanner = c("OLS", "IV")
#   ) %>%
#   as_gt() %>%
#   gt::tab_style(
#     style = gt::cell_text(weight = "bold"),
#     locations = gt::cells_row_groups(groups = everything())
#   ) %>%
#   gt::tab_header(
#     title=gt::md("**Regression Results for Percent of Female Borrowers**")
#   ) %>%
#   gt::fmt_number(
#     columns=everything(),
#     decimals = 4
#   )
  
pct_female_FE <- tbl_merge(
  tbls = list(mfi_fe_pct, country_fe_pct, region_fe_pct),
  tab_spanner = c("**MFI Fixed Effects**", "**Country Fixed Effects**", "**Region Fixed Effects**")
)

pct_female_FE_IV <- tbl_merge(
  tbls=list(mfi_feiv_pct, country_feiv_pct, region_feiv_pct),
  tab_spanner = c("**MFI Fixed Effects**", "**Country Fixed Effects**", "**Region Fixed Effects**")
)



pct_female_FEvsIV <- tbl_stack(
  tbls=list(pct_female_FE, pct_female_FE_IV),
  group_header = c("OLS", "IV")
  ) %>%
  as_gt() %>%
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_row_groups(groups = everything())
  )%>%
  gt::tab_header(
    title=gt::md("**Regression Results for Percent of Female Borrowers**")
  )


print(pct_female_FEvsIV)

```
```{r}
#ratio of female borrwers
#only fixed effects, no instrumented variable
mfi_fe_rat <- tbl_regression(time_mfi_fe_rat)
country_fe_rat <- tbl_regression(time_country_fe_rat)
region_fe_rat <- tbl_regression(time_region_fe_rat)

#with IV
mfi_feiv_rat <- tbl_regression(fe_inst_2_rat_mfi)
country_feiv_rat <- tbl_regression(fe_inst_2_rat_country)
region_feiv_rat <- tbl_regression(fe_inst_2_rat_reg)

# rat_female_FE <- tbl_stack(
#   tbls = list(mfi_fe_rat, country_fe_rat, region_fe_rat),
#   group_header = c("MFI Fixed Effects", "Country Fixed Effects", "Region Fixed Effects")
# )
# 
# rat_female_FE_IV <- tbl_stack(
#   tbls = list(mfi_feiv_rat, country_feiv_rat, region_feiv_rat),
#   group_header = c("MFI Fixed Effects", "Country Fixed Effects", "Region Fixed Effects")
# )

# rat_female_FEvsIV <- tbl_merge(
#   tbls = list(rat_female_FE, rat_female_FE_IV),
#   tab_spanner = c("OLS", "IV")
# ) %>%
#   as_gt() %>%
#   gt::tab_style(
#     style = gt::cell_text(weight = "bold"),
#     locations = gt::cells_row_groups(groups = everything())
#   )%>%
#   gt::tab_header(
#     title=gt::md("**Regression Results for Ratio of GLP to Female Borrowers**")
#   ) %>%
#   gt::fmt_number(
#     columns=everything(),
#     decimals = 4
#   )

# print(rat_female_FEvsIV)

rat_female_FE <- tbl_merge(
  tbls = list(mfi_fe_rat, country_fe_rat, region_fe_rat),
  tab_spanner = c("**MFI Fixed Effects**", "**Country Fixed Effects**", "**Region Fixed Effects**")
)

rat_female_FE_IV <- tbl_merge(
  tbls=list(mfi_feiv_rat, country_feiv_rat, region_feiv_rat),
  tab_spanner = c("**MFI Fixed Effects**", "**Country Fixed Effects**", "**Region Fixed Effects**")
)



rat_female_FEvsIV <- tbl_stack(
  tbls=list(rat_female_FE, rat_female_FE_IV),
  group_header = c("OLS", "IV")
  ) %>%
  as_gt() %>%
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_row_groups(groups = everything())
  )%>%
  gt::tab_header(
    title=gt::md("**Regression Results for Fraction of GLP to Female Borrowers**")
  )


print(rat_female_FEvsIV)
```

IV coefficients
```{r}
#these are the coefficients on current interest rate in the instrumental variable regressions
#will show how good the instrument is

#Percent of female borrowers
cur_mfi_iv_pct <- tbl_regression(fe_inst_1_mfi)
cur_country_iv_pct <- tbl_regression(fe_inst_1_country)
cur_reg_iv_pct <- tbl_regression(fe_inst_1_reg)

pct_cur <- tbl_stack(
  tbls = list(cur_mfi_iv_pct, cur_country_iv_pct, cur_reg_iv_pct),
  group_header = c("MFI Fixed Effects", "Country Fixed Effects", "Region Fixed Effects")
) %>%
  bold_p() %>%
  as_gt() %>%
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_row_groups(groups = everything())
  )%>%
  gt::tab_header(
    title=gt::md("**Coefficients on Current Interest Rate**"),
    subtitle=gt::md("First Step of IV Regression of Percent of Female Borrowers")
  ) %>%
  gt::fmt_number(
    columns=everything(),
    decimals = 4
  )

print(pct_cur)

#Ratio of GLP to female borrowers
cur_mfi_iv_rat <- tbl_regression(fe_inst_1_rat_mfi)
cur_country_iv_rat<- tbl_regression(fe_inst_1_rat_country)
cur_reg_iv_rat <- tbl_regression(fe_inst_1_rat_reg)

rat_cur <- tbl_stack(
  tbls = list(cur_mfi_iv_rat, cur_country_iv_rat, cur_reg_iv_rat),
  group_header = c("MFI Fixed Effects", "Country Fixed Effects", "Region Fixed Effects")
) %>%
  bold_p() %>%
  as_gt() %>%
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_row_groups(groups = everything())
  )%>%
  gt::tab_header(
    title=gt::md("**Coefficients on Current Interest Rate**"),
    subtitle=gt::md("First Step of IV Regression")
  ) %>%
  gt::fmt_number(
    columns=everything(),
    decimals = 4
  )

print(rat_cur)


```


```{r}
# run above for all tables/graphs/analysis
```



















Not using

```{r}
#instrumental variable only, no fixed effects, still using log of GLP

#looking at raw change in GLP based on change in interest rate (which is already in percentage points)
#dont use
# ir_inst_step1 <- lm(Gross_Loan_Portfolio ~ Cur_Interest_Rate, data=working_mf_interest)
# summary(ir_inst_step1)
# working_mf_interest$predicted_GLP <- predict(ir_inst_step1)
# 
# ir_inst_step2 <- lm(Ratio_GLP_Female ~ log(predicted_GLP), data = working_mf_interest)
# summary(ir_inst_step2)


#looking at percent change in GLP based on change in interest rate (which is already in percentage points)
# ir_log_inst_step1 <- lm(log(Gross_Loan_Portfolio) ~ Cur_Interest_Rate, data=working_mf_interest)
# summary(ir_log_inst_step1)
# working_mf_interest$predicted_GLP <- predict(ir_log_inst_step1)
# 
# ir_log_inst_step2 <- lm(Ratio_GLP_Female ~ log(predicted_GLP), data = working_mf_interest)
# summary(ir_log_inst_step2)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
